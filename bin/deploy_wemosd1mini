#!/bin/bash
# deploy ulnoiot software on wemos d1 mini
#
# $1 can give a tty port as destination parameter (for example: USB0)
#

# find directory
dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
"$dir/check_dependencies" || exit 1
EXTERNAL="$dir/../external"
VPYTHON="$EXTERNAL/ulnoiot_vp/"
source "$VPYTHON/bin/activate"

port=$("$dir/find_esp_port" "$1")

cd "$dir/../lib/boards/wemosd1mini"

echo "Copying all files."
mpfshell -n -c "
  open tty$port;
  mput .*\\.py\$;
  md ulnoiot;
  lcd ulnoiot;
  cd ulnoiot;
  mput .*\\.py\$;
  md shield;
  lcd shield;
  cd shield;
  mput .*\\.py\$;
  lcd ..;
  cd ..;
  md help;
  lcd help;
  cd help;
  mput .*\\.py\$;
  mput .*\\.txt\$;
  cd /;" 2>&1 | grep -v "Invalid directory"

echo "Sending reset."
"$dir/board_reset" $port

